<h1 id="tinyjs-resource-loader">tinyjs-resource-loader</h1>
<p>用于处理 tinyjs 游戏资源的 webpack loader，旨在让 tinyjs 项目中的动画帧（雪碧图）合成流程更加符合 webpack 工作流</p>
<h2 id="安装">安装</h2>
<p><code>npm install tinyjs-resource-loader -D</code></p>
<h2 id="使用方法">使用方法</h2>
<ol>
<li>在动画帧（雪碧图）目录中创建 <code>.tileset</code> （或任意名称）配置文件</li>
</ol>
<pre><code class="bash language-bash">animation
├── .tileset
├── 001.png
├── 002.png
└── 003.png</code></pre>
<ol>
<li>参照<a href="#图片处理参数">图片处理参数</a>以 <code>yaml</code> 格式对 <code>.tileset</code> 进行配置</li>
</ol>
<pre><code class="yaml language-yaml">skip: 1
colors: 16
scale: 0.5</code></pre>
<ol>
<li>在 <code>webpack.config.js</code> 中配置 <code>tinyjs-resource-loader</code>，该 loader 应作用于上面的配置文件</li>
</ol>
<pre><code class="javascript language-javascript">module.export = {
  // statements
  module: {
    loaders: [
      {
        test: /\.tileset/i,
        loader: 'tinyjs-resource-loader',
        query: {
          output: 'game/images',
          image: { // 图片的 url-loader 参数
            name: 'resources/[name].[ext]',
            limit: 4096
          },
          json: { // JSON 的 url-loader 参数
            name: 'resources/[name].[ext]',
            limit: 1
          }
        }
      }
    ]
  },
  output: {
    path: path.resovle('dist')
  }
};</code></pre>
<ol>
<li>在模块中引用 <code>.tileset</code> 文件</li>
</ol>
<pre><code class="javascript language-javascript">import tilesetAnimationJSON from './frames/animation/.tileset';
// 得到的是 JSON 文件的路径，并且 JSON 中图片的路径会自动根据 resources/[name].[ext] 配置项进行替换</code></pre>
<h2 id="处理过程">处理过程</h2>
<ol>
<li>动画抽帧：通过指定 <code>skip</code> 配置项来实现每 N 帧抽取一帧的功能</li>
<li>合成雪碧图：通过 <a href="https://github.com/krzysztof-o/spritesheet.js">spritesheet.js</a> 将图片合成雪碧图并生成 tinyjs 所需的 JSON 文件</li>
<li>图片压缩：利用 <a href="https://github.com/papandreou/node-pngquant">node-pngquant</a> 对合成的 PNG 格式图片按照 <code>colors</code> 指定的颜色值进行压缩</li>
<li>将处理得到的 JSON 和图片文件写入 <code>game/images</code> 目录（由 <code>query.output</code> 指定）</li>
</ol>
<pre><code class="bash language-bash">game
├── frames
│   ├── animation # 这里是动画帧存放的目录
│   │   ├── .tileset
│   │   ├── 001.png
│   │   ├── 002.png
│   │   └── 003.png
├── images # 图片处理后的 JSON 和图片存放目录
│   ├── tileset-animation.json
│   └── tileset-animation.png
└── resources.js</code></pre>
<ol>
<li>最后通过 <a href="https://github.com/webpack-contrib/url-loader">url-loader</a> 将 <code>game/images</code>中的 JSON 和图片构建到 <code>dist/resources</code> 中（由 webpack config 中的 <code>output.path</code> 指定）。这一步会自动将 JSON 中 <code>meta.image</code> 项替换为图片的 <code>publicPath</code> 或 <code>base64</code> 编码（取决于 <code>query.image</code> 的配置）</li>
</ol>
<pre><code class="bash language-bash">dist
└── resources
    ├── tileset-animation.json
    └── tileset-animation.png</code></pre>
<h2 id="系统依赖">系统依赖</h2>
<p>在使用 tinyjs-resource-loader 处理 tinyjs 项目中的 JSON 和 png 之前，首先应确保系统中安装了以下工具：</p>
<ul>
<li><a href="https://www.imagemagick.org/script/download.php">ImageMagick</a>：提供 <a href="https://github.com/krzysztof-o/spritesheet.js">spritesheet.js</a> 合成雪碧图所需的 <code>identify</code> 命令（主要用于获取一个或多个图像文件的格式和特性）</li>
<li><a href="https://pngquant.org/">pngquant</a>：提供 <a href="https://github.com/papandreou/node-pngquant">node-pngquant</a> 压缩图片所需的 <code>pngquant</code> 命令</li>
</ul>
<blockquote>
  <p>注意：如果系统中没有安装以上的依赖，构建时会跳过处理过程中的前 4 步，直接从 <code>output</code> 读取 JSON 和图片，并通过 <a href="https://github.com/webpack-contrib/url-loader">url-loader</a> 将它们构建到指定目录中，但会产生 webpack warning。这是为了确保项目在构建过一次以后，在 windows 环境或者远程机器也能够进行构建，兼顾跨平台或者云构建的需求</p>
</blockquote>
<h2 id="配置参数">配置参数</h2>
<ul>
<li><code>query.output</code>: 图片处理后输出 JSON 和图片文件的目录，一般选择源码中的目录，建议提交远程仓库</li>
<li><code>query.image</code>：图片文件的 <a href="https://github.com/webpack-contrib/url-loader">url-loader</a> 参数</li>
<li><code>query.json</code>：JSON 文件的 <a href="https://github.com/webpack-contrib/url-loader">url-loader</a> 参数</li>
</ul>
<h2 id="图片处理参数">图片处理参数</h2>
<ul>
<li><code>trim</code>：移除图片周围的空白，参照 <a href="https://github.com/krzysztof-o/spritesheet.js">spritesheet.js</a>，默认 <code>false</code></li>
<li><code>scale</code>: 图片缩放比例，基于 <a href="https://github.com/eivindfjeldstad/imagemagick-stream">imagemagick-stream</a> 对图片进行缩放，默认 <code>1</code></li>
<li><code>padding</code>: 雪碧图中图片的间隙，参照 <a href="https://github.com/krzysztof-o/spritesheet.js">spritesheet.js</a>，默认 <code>10</code></li>
<li><code>skip</code>：抽帧时跳过的帧数，如果指定为 N，会每跳过 N 帧保留一帧，默认 <code>0</code></li>
<li><code>colors</code>：雪碧图进行图片压缩的颜色数，默认 <code>256</code></li>
<li><code>files</code>: 以 <code>[path]-[name]</code> 对象格式配置的文件路径，如果配置了 <code>files</code>，将不会从 <code>.tileset</code> 所在目录读取动画帧，而且从 <code>files</code> 指定的路径中读取</li>
</ul>
<p><code>files</code> 配置的路径为相对于 <code>.tileset</code> 所在目录的路径，示例：</p>
<pre><code class="yaml language-yaml">files:
  ../animation-a/001.png: animation-a
  ../animation-b/001.png: animation-b
  ../animation-c/001.png: animation-c</code></pre>