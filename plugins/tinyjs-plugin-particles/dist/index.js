/*!
 * tinyjs-plugin-particles
 * Description: A really fast type of the Container built solely for speed
 * Author: fangjun.yfj
 * Version: v0.0.2
 */
!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.particles=e():(t.Tiny=t.Tiny||{},t.Tiny.particles=e())}(this,function(){return function(t){function e(i){if(r[i])return r[i].exports;var o=r[i]={exports:{},id:i,loaded:!1};return t[i].call(o.exports,o,o.exports,e),o.loaded=!0,o.exports}var r={};return e.m=t,e.c=r,e.p="/dist",e(0)}([function(t,e,r){t.exports=r(1)},function(t,e,r){"use strict";function i(t){return t&&t.__esModule?t:{default:t}}Object.defineProperty(e,"__esModule",{value:!0});var o=r(2);Object.defineProperty(e,"ParticleContainer",{enumerable:!0,get:function(){return i(o).default}});var n=r(3);Object.defineProperty(e,"ParticleRenderer",{enumerable:!0,get:function(){return i(n).default}})},function(t,e){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function o(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var n=function(){function t(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,r,i){return r&&t(e.prototype,r),i&&t(e,i),e}}(),a=function t(e,r,i){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,r);if(void 0===o){var n=Object.getPrototypeOf(e);return null===n?void 0:t(n,r,i)}if("value"in o)return o.value;var a=o.get;if(void 0!==a)return a.call(i)},s=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1500,o=arguments[1],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:16384;r(this,e);var a=i(this,(e.__proto__||Object.getPrototypeOf(e)).call(this)),s=16384;return n>s&&(n=s),n>t&&(n=t),a._properties=[!1,!0,!1,!1,!1],a._maxSize=t,a._batchSize=n,a._glBuffers={},a._bufferToUpdate=0,a.interactiveChildren=!1,a.blendMode=Tiny.BLEND_MODES.NORMAL,a.roundPixels=!0,a.baseTexture=null,a.setProperties(o),a._tint=null,a._tintRGB=[],a.tint=16777215,a}return o(e,t),n(e,[{key:"setProperties",value:function(t){t&&(this._properties[0]="scale"in t?!!t.scale:this._properties[0],this._properties[1]="position"in t?!!t.position:this._properties[1],this._properties[2]="rotation"in t?!!t.rotation:this._properties[2],this._properties[3]="uvs"in t?!!t.uvs:this._properties[3],this._properties[4]="alpha"in t?!!t.alpha:this._properties[4])}},{key:"updateTransform",value:function(){this.displayObjectUpdateTransform()}},{key:"renderWebGL",value:function(t){var e=this;this.visible&&!(this.worldAlpha<=0)&&this.children.length&&this.renderable&&(this.baseTexture||(this.baseTexture=this.children[0]._texture.baseTexture,this.baseTexture.hasLoaded||this.baseTexture.once("update",function(){return e.onChildrenChange(0)})),t.setObjectRenderer(t.plugins.particle),t.plugins.particle.render(this))}},{key:"onChildrenChange",value:function(t){var e=Math.floor(t/this._batchSize);e<this._bufferToUpdate&&(this._bufferToUpdate=e)}},{key:"renderCanvas",value:function(t){if(this.visible&&!(this.worldAlpha<=0)&&this.children.length&&this.renderable){var e=t.context,r=this.worldTransform,i=!0,o=0,n=0,a=0,s=0,u=t.blendModes[this.blendMode];u!==e.globalCompositeOperation&&(e.globalCompositeOperation=u),e.globalAlpha=this.worldAlpha,this.displayObjectUpdateTransform();for(var l=0;l<this.children.length;++l){var f=this.children[l];if(f.visible){var c=f._texture.frame;if(e.globalAlpha=this.worldAlpha*f.alpha,f.rotation%(2*Math.PI)===0)i&&(e.setTransform(r.a,r.b,r.c,r.d,r.tx*t.resolution,r.ty*t.resolution),i=!1),o=f.anchor.x*(-c.width*f.scale.x)+f.position.x+.5,n=f.anchor.y*(-c.height*f.scale.y)+f.position.y+.5,a=c.width*f.scale.x,s=c.height*f.scale.y;else{i||(i=!0),f.displayObjectUpdateTransform();var h=f.worldTransform;t.roundPixels?e.setTransform(h.a,h.b,h.c,h.d,h.tx*t.resolution|0,h.ty*t.resolution|0):e.setTransform(h.a,h.b,h.c,h.d,h.tx*t.resolution,h.ty*t.resolution),o=f.anchor.x*-c.width+.5,n=f.anchor.y*-c.height+.5,a=c.width,s=c.height}var d=f._texture.baseTexture.resolution;e.drawImage(f._texture.baseTexture.source,c.x*d,c.y*d,c.width*d,c.height*d,o*t.resolution,n*t.resolution,a*t.resolution,s*t.resolution)}}}}},{key:"getBounds",value:function(){if(!(this.children.length<=0)){var t=this.children[0].getBounds(),e=t.left,r=t.top,i=t.right,o=t.bottom;return this.children.forEach(function(t){var n=t.getBounds();n.x<e&&(e=n.left),n.y<r&&(r=n.top),n.x>i&&(i=n.right),n.y>o&&(o=n.bottom)}),new Tiny.Rectangle(e,r,i-e,o-r)}}},{key:"destroy",value:function(t){if(a(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"destroy",this).call(this,t),this._buffers)for(var r=0;r<this._buffers.length;++r)this._buffers[r].destroy();this._properties=null,this._buffers=null}},{key:"tint",get:function(){return this._tint},set:function(t){this._tint=t,Tiny.hex2rgb(t,this._tintRGB)}}]),e}(Tiny.Container);t.exports=s},function(t,e,r){"use strict";function i(t){return t&&t.__esModule?t:{default:t}}function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function n(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function a(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0});var s=function(){function t(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,r,i){return r&&t(e.prototype,r),i&&t(e,i),e}}(),u=function t(e,r,i){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,r);if(void 0===o){var n=Object.getPrototypeOf(e);return null===n?void 0:t(n,r,i)}if("value"in o)return o.value;var a=o.get;if(void 0!==a)return a.call(i)},l=r(4),f=i(l),c=r(5),h=i(c),d=function(t){function e(t){o(this,e);var r=n(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return r.shader=null,r.indexBuffer=null,r.properties=null,r.tempMatrix=new Tiny.Matrix,r.CONTEXT_UID=0,r}return a(e,t),s(e,[{key:"onContextChange",value:function(){var t=this.renderer.gl;this.CONTEXT_UID=this.renderer.CONTEXT_UID,this.shader=new f.default(t),this.properties=[{attribute:this.shader.attributes.aVertexPosition,size:2,uploadFunction:this.uploadVertices,offset:0},{attribute:this.shader.attributes.aPositionCoord,size:2,uploadFunction:this.uploadPosition,offset:0},{attribute:this.shader.attributes.aRotation,size:1,uploadFunction:this.uploadRotation,offset:0},{attribute:this.shader.attributes.aTextureCoord,size:2,uploadFunction:this.uploadUvs,offset:0},{attribute:this.shader.attributes.aColor,size:1,uploadFunction:this.uploadAlpha,offset:0}]}},{key:"start",value:function(){this.renderer.bindShader(this.shader)}},{key:"render",value:function(t){var e=t.children,r=t._maxSize,i=t._batchSize,o=this.renderer,n=e.length;if(0!==n){n>r&&(n=r);var a=t._glBuffers[o.CONTEXT_UID];a||(a=t._glBuffers[o.CONTEXT_UID]=this.generateBuffers(t)),this.renderer.setBlendMode(t.blendMode);var s=o.gl,u=t.worldTransform.copy(this.tempMatrix);u.prepend(o._activeRenderTarget.projectionMatrix),this.shader.uniforms.projectionMatrix=u.toArray(!0),this.shader.uniforms.uAlpha=t.worldAlpha,this.shader.uniforms.tint=t._tintRGB;var l=e[0]._texture.baseTexture;this.shader.uniforms.uSampler=o.bindTexture(l);for(var f=0,c=0;f<n;f+=i,c+=1){var h=n-f;h>i&&(h=i);var d=a[c];d.uploadDynamic(e,f,h),t._bufferToUpdate===c&&(d.uploadStatic(e,f,h),t._bufferToUpdate=c+1),o.bindVao(d.vao),d.vao.draw(s.TRIANGLES,6*h)}}}},{key:"generateBuffers",value:function(t){for(var e=this.renderer.gl,r=[],i=t._maxSize,o=t._batchSize,n=t._properties,a=0;a<i;a+=o)r.push(new h.default(e,this.properties,n,o));return r}},{key:"uploadVertices",value:function(t,e,r,i,o,n){for(var a=0,s=0,u=0,l=0,f=0;f<r;++f){var c=t[e+f],h=c._texture,d=c.scale.x,p=c.scale.y,y=h.trim,v=h.orig;y?(s=y.x-c.anchor.x*v.width,a=s+y.width,l=y.y-c.anchor.y*v.height,u=l+y.height):(a=v.width*(1-c.anchor.x),s=v.width*-c.anchor.x,u=v.height*(1-c.anchor.y),l=v.height*-c.anchor.y),i[n]=s*d,i[n+1]=l*p,i[n+o]=a*d,i[n+o+1]=l*p,i[n+2*o]=a*d,i[n+2*o+1]=u*p,i[n+3*o]=s*d,i[n+3*o+1]=u*p,n+=4*o}}},{key:"uploadPosition",value:function(t,e,r,i,o,n){for(var a=0;a<r;a++){var s=t[e+a].position;i[n]=s.x,i[n+1]=s.y,i[n+o]=s.x,i[n+o+1]=s.y,i[n+2*o]=s.x,i[n+2*o+1]=s.y,i[n+3*o]=s.x,i[n+3*o+1]=s.y,n+=4*o}}},{key:"uploadRotation",value:function(t,e,r,i,o,n){for(var a=0;a<r;a++){var s=t[e+a].rotation;i[n]=s,i[n+o]=s,i[n+2*o]=s,i[n+3*o]=s,n+=4*o}}},{key:"uploadUvs",value:function(t,e,r,i,o,n){for(var a=0;a<r;++a){var s=t[e+a]._texture._uvs;s?(i[n]=s.x0,i[n+1]=s.y0,i[n+o]=s.x1,i[n+o+1]=s.y1,i[n+2*o]=s.x2,i[n+2*o+1]=s.y2,i[n+3*o]=s.x3,i[n+3*o+1]=s.y3,n+=4*o):(i[n]=0,i[n+1]=0,i[n+o]=0,i[n+o+1]=0,i[n+2*o]=0,i[n+2*o+1]=0,i[n+3*o]=0,i[n+3*o+1]=0,n+=4*o)}}},{key:"uploadAlpha",value:function(t,e,r,i,o,n){for(var a=0;a<r;a++){var s=t[e+a].alpha;i[n]=s,i[n+o]=s,i[n+2*o]=s,i[n+3*o]=s,n+=4*o}}},{key:"destroy",value:function(){this.renderer.gl&&this.renderer.gl.deleteBuffer(this.indexBuffer),u(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"destroy",this).call(this),this.shader.destroy(),this.indices=null,this.tempMatrix=null}}]),e}(Tiny.ObjectRenderer);Tiny.WebGLRenderer.registerPlugin("particle",d),e.default=d},function(t,e){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function o(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0});var n=function(t){function e(t){return r(this,e),i(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,["attribute vec2 aVertexPosition;","attribute vec2 aTextureCoord;","attribute float aColor;","attribute vec2 aPositionCoord;","attribute vec2 aScale;","attribute float aRotation;","uniform mat3 projectionMatrix;","varying vec2 vTextureCoord;","varying float vColor;","void main(void){","   vec2 v = aVertexPosition;","   v.x = (aVertexPosition.x) * cos(aRotation) - (aVertexPosition.y) * sin(aRotation);","   v.y = (aVertexPosition.x) * sin(aRotation) + (aVertexPosition.y) * cos(aRotation);","   v = v + aPositionCoord;","   gl_Position = vec4((projectionMatrix * vec3(v, 1.0)).xy, 0.0, 1.0);","   vTextureCoord = aTextureCoord;","   vColor = aColor;","}"].join("\n"),["varying vec2 vTextureCoord;","varying float vColor;","uniform sampler2D uSampler;","uniform float uAlpha;","uniform vec3 tint;","void main(void){","  vec4 color = texture2D(uSampler, vTextureCoord) * vColor * vec4(tint * uAlpha, uAlpha);","  if (color.a == 0.0) discard;","  gl_FragColor = color;","}"].join("\n")))}return o(e,t),e}(Tiny.Shader);e.default=n},function(t,e,r){"use strict";function i(t){return t&&t.__esModule?t:{default:t}}function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,r,i){return r&&t(e.prototype,r),i&&t(e,i),e}}(),a=r(6),s=i(a),u=function(){function t(e,r,i,n){o(this,t),this.gl=e,this.vertSize=2,this.vertByteSize=4*this.vertSize,this.size=n,this.dynamicProperties=[],this.staticProperties=[];for(var a=0;a<r.length;++a){var s=r[a];s={attribute:s.attribute,size:s.size,uploadFunction:s.uploadFunction,offset:s.offset},i[a]?this.dynamicProperties.push(s):this.staticProperties.push(s)}this.staticStride=0,this.staticBuffer=null,this.staticData=null,this.dynamicStride=0,this.dynamicBuffer=null,this.dynamicData=null,this.initBuffers()}return n(t,[{key:"initBuffers",value:function(){var t=this.gl,e=0;this.indices=(0,s.default)(this.size),this.indexBuffer=Tiny.glCore.GLBuffer.createIndexBuffer(t,this.indices,t.STATIC_DRAW),this.dynamicStride=0;for(var r=0;r<this.dynamicProperties.length;++r){var i=this.dynamicProperties[r];i.offset=e,e+=i.size,this.dynamicStride+=i.size}this.dynamicData=new Float32Array(this.size*this.dynamicStride*4),this.dynamicBuffer=Tiny.glCore.GLBuffer.createVertexBuffer(t,this.dynamicData,t.STREAM_DRAW);var o=0;this.staticStride=0;for(var n=0;n<this.staticProperties.length;++n){var a=this.staticProperties[n];a.offset=o,o+=a.size,this.staticStride+=a.size}this.staticData=new Float32Array(this.size*this.staticStride*4),this.staticBuffer=Tiny.glCore.GLBuffer.createVertexBuffer(t,this.staticData,t.STATIC_DRAW),this.vao=new Tiny.glCore.VertexArrayObject(t).addIndex(this.indexBuffer);for(var u=0;u<this.dynamicProperties.length;++u){var l=this.dynamicProperties[u];this.vao.addAttribute(this.dynamicBuffer,l.attribute,t.FLOAT,!1,4*this.dynamicStride,4*l.offset)}for(var f=0;f<this.staticProperties.length;++f){var c=this.staticProperties[f];this.vao.addAttribute(this.staticBuffer,c.attribute,t.FLOAT,!1,4*this.staticStride,4*c.offset)}}},{key:"uploadDynamic",value:function(t,e,r){for(var i=0;i<this.dynamicProperties.length;i++){var o=this.dynamicProperties[i];o.uploadFunction(t,e,r,this.dynamicData,this.dynamicStride,o.offset)}this.dynamicBuffer.upload()}},{key:"uploadStatic",value:function(t,e,r){for(var i=0;i<this.staticProperties.length;i++){var o=this.staticProperties[i];o.uploadFunction(t,e,r,this.staticData,this.staticStride,o.offset)}this.staticBuffer.upload()}},{key:"destroy",value:function(){this.dynamicProperties=null,this.dynamicData=null,this.dynamicBuffer.destroy(),this.staticProperties=null,this.staticData=null,this.staticBuffer.destroy()}}]),t}();e.default=u},function(t,e){"use strict";function r(t){for(var e=6*t,r=new Uint16Array(e),i=0,o=0;i<e;i+=6,o+=4)r[i+0]=o+0,r[i+1]=o+1,r[i+2]=o+2,r[i+3]=o+0,r[i+4]=o+2,r[i+5]=o+3;return r}Object.defineProperty(e,"__esModule",{value:!0}),e.default=r}])});