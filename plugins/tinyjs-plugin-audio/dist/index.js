/*!
 * tinyjs-plugin-audio
 * Description: Tiny.js 音效插件
 * Author: fangjun.yfj
 * Version: v0.0.4
 */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.audio=t():(e.Tiny=e.Tiny||{},e.Tiny.audio=t())}(this,function(){return function(e){function t(i){if(o[i])return o[i].exports;var r=o[i]={exports:{},id:i,loaded:!1};return e[i].call(r.exports,r,r.exports,t),r.loaded=!0,r.exports}var o={};return t.m=e,t.c=o,t.p="/dist",t(0)}([function(e,t,o){e.exports=o(1)},function(e,t,o){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.manager=t.com=void 0;var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n=o(2),a=i(n),u=o(3),s=i(u),d=o(4),l=i(d),c=o(5),p=o(6),f=i(p),h={utils:a.default,AudioManager:s.default,AudioAnalyser:f.default,Audio:l.default,audioParser:c.audioParser,audioUrlParser:c.audioUrlParser},y=Tiny.loaders.Loader;y.addTinyMiddleware(h.audioParser);var v=y.prototype.add;y.prototype.add=function(e,t,o,i){return"object"===("undefined"==typeof e?"undefined":r(e))&&"[object Array]"===Object.prototype.toString.call(e.url)&&(e.url=h.audioUrlParser(e.url)),"[object Array]"===Object.prototype.toString.call(t)&&(t=h.audioUrlParser(t)),Tiny.isArray(e)&&e.forEach(function(t,o){var i=void 0;t.url?(i=h.audioUrlParser(t.url),i&&(e[o].url=i)):(i=h.audioUrlParser(t),i&&(e[o]=i))}),v.call(this,e,t,o,i)},Tiny.Loader&&(Tiny.Loader=y?new y:null);var b=new h.AudioManager;t.com=h,t.manager=b},function(e,t){"use strict";function o(e){a?(delete i._loadTypeMap.mp3,delete i._loadTypeMap.ogg,delete i._loadTypeMap.wav,i._xhrTypeMap.mp3=i.XHR_RESPONSE_TYPE.BUFFER,i._xhrTypeMap.ogg=i.XHR_RESPONSE_TYPE.BUFFER,i._xhrTypeMap.wav=i.XHR_RESPONSE_TYPE.BUFFER,i.setExtensionXhrType(e,i.XHR_RESPONSE_TYPE.BUFFER)):i.setExtensionLoadType(e,i.LOAD_TYPE.AUDIO)}Object.defineProperty(t,"__esModule",{value:!0});var i=Tiny.loaders.Resource,r=!!window.Audio,n=window.AudioContext||window.webkitAudioContext,a=!!n,u=a||r,s=!1,d=!1,l=!1,c=!1,p=null,f=a?new n:null;if(u){var h=document.createElement("audio");s=""!==h.canPlayType("audio/mpeg;"),d=""!==h.canPlayType('audio/ogg; codecs="vorbis"'),l=""!==h.canPlayType("audio/wav"),c=""!==h.canPlayType('audio/mp4; codecs="mp4a.40.5"'),s&&o("mp3"),d&&o("ogg"),l&&o("wav"),c&&o("m4a"),a&&(p=function(){return f.createGain?f.createGain():f.createGainNode()})}t.default={isHTMLAudioSupported:r,webAudioContext:n,isWebAudioSupported:a,isAudioSupported:u,isMp3Supported:s,isOggSupported:d,isWavSupported:l,isM4aSupported:c,globalWebAudioContext:f,createGainNode:p}},function(e,t,o){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var o=0;o<t.length;o++){var i=t[o];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,o,i){return o&&e(t.prototype,o),i&&e(t,i),t}}(),a=o(1),u=o(4),s=i(u),d=function(){function e(){r(this,e),this.sounds=[]}return n(e,[{key:"getAudio",value:function(t){var o=new s.default(e.audios[a.com.audioUrlParser(t)||t],this);return this.sounds.push(o),o}},{key:"removeAudio",value:function(e){var t=this.sounds.indexOf(e);t!==-1&&this.sounds.splice(t,1)}},{key:"pause",value:function(e){e=e!==!1;var t=this.sounds.length;if(e)for(var o=0;o<t;o++)this.sounds[o].pause();else for(var i=0;i<t;i++)this.sounds[i].play()}},{key:"resume",value:function(){return this.pause(!1)}}]),e}();d.audios={},t.default=d},function(e,t,o){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function a(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){for(var o=0;o<t.length;o++){var i=t[o];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,o,i){return o&&e(t.prototype,o),i&&e(t,i),t}}(),s=o(2),d=i(s),l=function(e){function t(e,o){r(this,t);var i=n(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return i.manager=o,i.data=e,d.default.isWebAudioSupported?(i.context=d.default.globalWebAudioContext,i.gainNode=d.default.createGainNode()):(i.audio=new window.Audio,i.audio.addEventListener("ended",i._onEnd.bind(i))),i.reset(),i}return a(t,e),u(t,[{key:"play",value:function(){return this.playing?this:(this.playing=!0,this.emit("play"),d.default.isWebAudioSupported?(this.source=this.context.createBufferSource(),this.source.start=this.source.start||this.source.noteOn,this.source.stop=this.source.stop||this.source.noteOff,this.source.loop=this.loop,this.source.onended=this._onEnd.bind(this),this._startTime=this.context.currentTime,this.source.connect(this.gainNode),this.gainNode.connect(this.context.destination),this.source.buffer=this.data,this.source.start(0,this._paused?this._lastPauseTime:0)):(this.audio.src=this.data.children[0].src,this.audio.preload="auto",this.audio.load(),this.audio.play()),this)}},{key:"stop",value:function(){return this.emit("stop"),d.default.isWebAudioSupported?(this.source.stop(0),this._paused=!1,this._startTime=this.context.currentTime):(this.audio.pause(),this.audio.currentTime=0),this.playing=!1,this._paused=!1,this.reset(),this}},{key:"pause",value:function(){return this.playing?(this.emit("pause"),this._offsetTime+=this.context.currentTime-this._startTime,this._lastPauseTime=this._offsetTime%this.data.duration,d.default.isWebAudioSupported?this.source.stop(0):this.audio.pause(),this.playing=!1,void(this._paused=!0)):this}},{key:"reset",value:function(){this._startTime=0,this._lastPauseTime=0,this._offsetTime=0,this.playing=!1,this._paused=!1,d.default.isWebAudioSupported&&(this.audio=null)}},{key:"remove",value:function(){this.manager.removeAudio(this)}},{key:"_onEnd",value:function(){d.default.isWebAudioSupported?this._paused||(this.reset(),this.emit("end")):this.loop?(this.audio.currentTime=0,this.audio.play()):(this.reset(),this.emit("end"))}},{key:"loop",get:function(){return this._loop},set:function(e){e!==this._loop&&(this._loop=e,d.default.isWebAudioSupported&&this.audio&&(this.audio.loop=e))}}]),t}(Tiny.EventEmitter);l.prototype._loop=!1,l.prototype._paused=!1,l.prototype._startTime=0,l.prototype._lastPauseTime=0,l.prototype._offsetTime=0,l.prototype.playing=!1,t.default=l},function(e,t,o){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function r(){return function(e,t){if(!l.default.isAudioSupported||!e.data)return t();var o=a(e.url);if(f.indexOf(o)===-1||!u(o))return t();var i=e.name||e.url;return l.default.isWebAudioSupported?void l.default.globalWebAudioContext.decodeAudioData(e.data,function(e){p.default.audios[i]=e,t()}):(p.default.audios[i]=e.data,t())}}function n(e){var t=void 0;if(!Tiny.isArray(e)){var o=[];o.push(e),e=o}for(var i=0;i<e.length;i++){var r=a(e[i]);f.indexOf(r)!==-1&&(t=u(r)?e[i]:e[i].replace(/\.[^\.\/\?\\]*(\?.*)?$/,"."+s()))}return t}function a(e){return e.split("?").shift().split(".").pop().toLowerCase()}function u(e){var t=!1;switch(e){case"m4a":t=l.default.isM4aSupported;break;case"mp3":t=l.default.isMp3Supported;break;case"ogg":t=l.default.isOggSupported;break;case"wav":t=l.default.isWavSupported}return t}function s(){var e=new Audio;return Tiny.detect(f,function(t){return e.canPlayType(h[t])?t:null})}Object.defineProperty(t,"__esModule",{value:!0}),t.audioParser=r,t.audioUrlParser=n;var d=o(2),l=i(d),c=o(3),p=i(c),f=["ogg","mp3"],h={mp3:"audio/mpeg",mp4:"audio/mp4",ogg:'audio/ogg; codecs="vorbis"',m4a:"audio/x-m4a",wav:'audio/wav; codecs="1"'}},function(e,t,o){"use strict";function i(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t.default=e,t}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var o=0;o<t.length;o++){var i=t[o];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,o,i){return o&&e(t.prototype,o),i&&e(t,i),t}}(),a=o(2),u=(i(a),function(){function e(t,o){r(this,e),this.analyser=t.context.createAnalyser(),this.analyser.fftSize=o||2048,this.data=new Uint8Array(this.analyser.frequencyBinCount),t.gainNode.connect(this.analyser)}return n(e,[{key:"getFrequencyData",value:function(){return this.analyser.getByteFrequencyData(this.data),this.data}},{key:"getAverageFrequency",value:function(){for(var e=0,t=this.getFrequencyData(),o=0;o<t.length;o++)e+=t[o];return e/t.length}}]),e}());t.default=u}])});