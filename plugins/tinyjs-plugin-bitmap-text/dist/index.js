/*!
 * tinyjs-plugin-bitmap-text
 * Description: Create a line or multiple lines of text using bitmap font
 * Author: fangjun.yfj
 * Version: v0.0.3
 */
!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.BitmapText=e():(t.Tiny=t.Tiny||{},t.Tiny.BitmapText=e())}(this,function(){return function(t){function e(r){if(n[r])return n[r].exports;var i=n[r]={exports:{},id:r,loaded:!1};return t[r].call(i.exports,i,i.exports,e),i.loaded=!0,i.exports}var n={};return e.m=t,e.c=n,e.p="/dist",e(0)}([function(t,e,n){t.exports=n(1)},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}var i=n(2),o=r(i),s=n(5),a=r(s),u=Tiny.loaders.Loader;u.addTinyMiddleware(o.default),Tiny.Loader&&(Tiny.Loader=u?new u:null),t.exports=a.default},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function i(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e.default=t,e}function o(t,e){t.bitmapFont=f.default.registerFont(t.data,e)}Object.defineProperty(e,"__esModule",{value:!0}),e.parse=o,e.default=function(){return function(t,e){if(!t.data||t.type!==l.TYPE.XML)return void e();if(0===t.data.getElementsByTagName("page").length||0===t.data.getElementsByTagName("info").length||null===t.data.getElementsByTagName("info")[0].getAttribute("face"))return void e();var n=t.isDataUrl?"":a.dirname(t.url);t.isDataUrl&&("."===n&&(n=""),this.baseUrl&&n&&("/"===this.baseUrl.charAt(this.baseUrl.length-1)&&(n+="/"),n=n.replace(this.baseUrl,""))),n&&"/"!==n.charAt(n.length-1)&&(n+="/");var r=n+t.data.getElementsByTagName("page")[0].getAttribute("file");if(Tiny.TextureCache[r])o(t,Tiny.TextureCache[r]),e();else{var i={crossOrigin:t.crossOrigin,loadType:l.LOAD_TYPE.IMAGE,metadata:t.metadata.imageMetadata,parentResource:t};this.add(t.name+"_image",r,i,function(n){o(t,n.texture),e()})}}};var s=n(3),a=i(s),u=n(5),f=r(u),l=Tiny.loaders.Resource},function(t,e,n){(function(t){"use strict";function n(t,e){for(var n=0,r=t.length-1;r>=0;r--){var i=t[r];"."===i?t.splice(r,1):".."===i?(t.splice(r,1),n++):n&&(t.splice(r,1),n--)}if(e)for(;n--;n)t.unshift("..");return t}function r(t,e){if(t.filter)return t.filter(e);for(var n=[],r=0;r<t.length;r++)e(t[r],r,t)&&n.push(t[r]);return n}var i=/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/,o=function(t){return i.exec(t).slice(1)};e.resolve=function(){for(var e="",i=!1,o=arguments.length-1;o>=-1&&!i;o--){var s=o>=0?arguments[o]:t.cwd();if("string"!=typeof s)throw new TypeError("Arguments to path.resolve must be strings");s&&(e=s+"/"+e,i="/"===s.charAt(0))}return e=n(r(e.split("/"),function(t){return!!t}),!i).join("/"),(i?"/":"")+e||"."},e.normalize=function(t){var i=e.isAbsolute(t),o="/"===s(t,-1);return t=n(r(t.split("/"),function(t){return!!t}),!i).join("/"),t||i||(t="."),t&&o&&(t+="/"),(i?"/":"")+t},e.isAbsolute=function(t){return"/"===t.charAt(0)},e.join=function(){var t=Array.prototype.slice.call(arguments,0);return e.normalize(r(t,function(t,e){if("string"!=typeof t)throw new TypeError("Arguments to path.join must be strings");return t}).join("/"))},e.relative=function(t,n){function r(t){for(var e=0;e<t.length&&""===t[e];e++);for(var n=t.length-1;n>=0&&""===t[n];n--);return e>n?[]:t.slice(e,n-e+1)}t=e.resolve(t).substr(1),n=e.resolve(n).substr(1);for(var i=r(t.split("/")),o=r(n.split("/")),s=Math.min(i.length,o.length),a=s,u=0;u<s;u++)if(i[u]!==o[u]){a=u;break}for(var f=[],u=a;u<i.length;u++)f.push("..");return f=f.concat(o.slice(a)),f.join("/")},e.sep="/",e.delimiter=":",e.dirname=function(t){var e=o(t),n=e[0],r=e[1];return n||r?(r&&(r=r.substr(0,r.length-1)),n+r):"."},e.basename=function(t,e){var n=o(t)[2];return e&&n.substr(-1*e.length)===e&&(n=n.substr(0,n.length-e.length)),n},e.extname=function(t){return o(t)[3]};var s="b"==="ab".substr(-1)?function(t,e,n){return t.substr(e,n)}:function(t,e,n){return e<0&&(e=t.length+e),t.substr(e,n)}}).call(e,n(4))},function(t,e){"use strict";function n(){throw new Error("setTimeout has not been defined")}function r(){throw new Error("clearTimeout has not been defined")}function i(t){if(l===setTimeout)return setTimeout(t,0);if((l===n||!l)&&setTimeout)return l=setTimeout,setTimeout(t,0);try{return l(t,0)}catch(e){try{return l.call(null,t,0)}catch(e){return l.call(this,t,0)}}}function o(t){if(c===clearTimeout)return clearTimeout(t);if((c===r||!c)&&clearTimeout)return c=clearTimeout,clearTimeout(t);try{return c(t)}catch(e){try{return c.call(null,t)}catch(e){return c.call(this,t)}}}function s(){y&&p&&(y=!1,p.length?g=p.concat(g):d=-1,g.length&&a())}function a(){if(!y){var t=i(s);y=!0;for(var e=g.length;e;){for(p=g,g=[];++d<e;)p&&p[d].run();d=-1,e=g.length}p=null,y=!1,o(t)}}function u(t,e){this.fun=t,this.array=e}function f(){}var l,c,h=t.exports={};!function(){try{l="function"==typeof setTimeout?setTimeout:n}catch(t){l=n}try{c="function"==typeof clearTimeout?clearTimeout:r}catch(t){c=r}}();var p,g=[],y=!1,d=-1;h.nextTick=function(t){var e=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)e[n-1]=arguments[n];g.push(new u(t,e)),1!==g.length||y||i(a)},u.prototype.run=function(){this.fun.apply(null,this.array)},h.title="browser",h.browser=!0,h.env={},h.argv=[],h.version="",h.versions={},h.on=f,h.addListener=f,h.once=f,h.off=f,h.removeListener=f,h.removeAllListeners=f,h.emit=f,h.prependListener=f,h.prependOnceListener=f,h.listeners=function(t){return[]},h.binding=function(t){throw new Error("process.binding is not supported")},h.cwd=function(){return"/"},h.chdir=function(t){throw new Error("process.chdir is not supported")},h.umask=function(){return 0}},function(t,e){"use strict";function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function r(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0});var o=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),s=function t(e,n,r){null===e&&(e=Function.prototype);var i=Object.getOwnPropertyDescriptor(e,n);if(void 0===i){var o=Object.getPrototypeOf(e);return null===o?void 0:t(o,n,r)}if("value"in i)return i.value;var s=i.get;if(void 0!==s)return s.call(r)},a=function(t){function e(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};n(this,e);var o=r(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return o._textWidth=0,o._textHeight=0,o._glyphs=[],o._font={tint:void 0!==i.tint?i.tint:16777215,align:i.align||"left",name:null,size:0},o.font=i.font,o._text=t,o.maxWidth=0,o.maxLineHeight=0,o._anchor=new Tiny.ObservablePoint(function(){o.dirty=!0},o,0,0),o.dirty=!1,o.updateText(),o}return i(e,t),o(e,[{key:"updateText",value:function(){for(var t=e.fonts[this._font.name],n=this._font.size/t.size,r=new Tiny.Point,i=[],o=[],s=null,a=0,u=0,f=0,l=-1,c=0,h=0,p=0;p<this.text.length;p++){var g=this.text.charCodeAt(p);if(/(\s)/.test(this.text.charAt(p))&&(l=p,c=a),/(?:\r\n|\r|\n)/.test(this.text.charAt(p)))o.push(a),u=Math.max(u,a),f++,r.x=0,r.y+=t.lineHeight,s=null;else if(l!==-1&&this.maxWidth>0&&r.x*n>this.maxWidth)Tiny.removeItems(i,l,p-l),p=l,l=-1,o.push(c),u=Math.max(u,c),f++,r.x=0,r.y+=t.lineHeight,s=null;else{var y=t.chars[g];y&&(s&&y.kerning[s]&&(r.x+=y.kerning[s]),i.push({texture:y.texture,line:f,charCode:g,position:new Tiny.Point(r.x+y.xOffset,r.y+y.yOffset)}),a=r.x+(y.texture.width+y.xOffset),r.x+=y.xAdvance,h=Math.max(h,y.yOffset+y.texture.height),s=g)}}o.push(a),u=Math.max(u,a);for(var d=[],m=0;m<=f;m++){var v=0;"right"===this._font.align?v=u-o[m]:"center"===this._font.align&&(v=(u-o[m])/2),d.push(v)}for(var x=i.length,b=this.tint,T=0;T<x;T++){var _=this._glyphs[T];_?_.texture=i[T].texture:(_=new Tiny.Sprite(i[T].texture),this._glyphs.push(_)),_.position.x=(i[T].position.x+d[i[T].line])*n,_.position.y=i[T].position.y*n,_.scale.x=_.scale.y=n,_.tint=b,_.parent||this.addChild(_)}for(var w=x;w<this._glyphs.length;++w)this.removeChild(this._glyphs[w]);if(this._textWidth=u*n,this._textHeight=(r.y+t.lineHeight)*n,0!==this.anchor.x||0!==this.anchor.y)for(var A=0;A<x;A++)this._glyphs[A].x-=this._textWidth*this.anchor.x,this._glyphs[A].y-=this._textHeight*this.anchor.y;this.maxLineHeight=h*n}},{key:"updateTransform",value:function(){this.validate(),this.containerUpdateTransform()}},{key:"getLocalBounds",value:function(){return this.validate(),s(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"getLocalBounds",this).call(this)}},{key:"validate",value:function(){this.dirty&&(this.updateText(),this.dirty=!1)}},{key:"tint",get:function(){return this._font.tint},set:function(t){this._font.tint="number"==typeof t&&t>=0?t:16777215,this.dirty=!0}},{key:"align",get:function(){return this._font.align},set:function(t){this._font.align=t||"left",this.dirty=!0}},{key:"anchor",get:function(){return this._anchor},set:function(t){"number"==typeof t?this._anchor.set(t):this._anchor.copy(t)}},{key:"font",get:function(){return this._font},set:function(t){t&&("string"==typeof t?(t=t.split(" "),this._font.name=1===t.length?t[0]:t.slice(1).join(" "),this._font.size=t.length>=2?parseInt(t[0],10):e.fonts[this._font.name].size):(this._font.name=t.name,this._font.size="number"==typeof t.size?t.size:parseInt(t.size,10)),this.dirty=!0)}},{key:"text",get:function(){return this._text},set:function(t){t=t.toString()||" ",this._text!==t&&(this._text=t,this.dirty=!0)}},{key:"textWidth",get:function(){return this.validate(),this._textWidth}},{key:"textHeight",get:function(){return this.validate(),this._textHeight}}],[{key:"registerFont",value:function(t,n){var r={},i=t.getElementsByTagName("info")[0],o=t.getElementsByTagName("common")[0],s=n.baseTexture.resolution||Tiny.settings.RESOLUTION;r.font=i.getAttribute("face"),r.size=parseInt(i.getAttribute("size"),10),r.lineHeight=parseInt(o.getAttribute("lineHeight"),10)/s,r.chars={};for(var a=t.getElementsByTagName("char"),u=0;u<a.length;u++){var f=a[u],l=parseInt(f.getAttribute("id"),10),c=new Tiny.Rectangle(parseInt(f.getAttribute("x"),10)/s+n.frame.x/s,parseInt(f.getAttribute("y"),10)/s+n.frame.y/s,parseInt(f.getAttribute("width"),10)/s,parseInt(f.getAttribute("height"),10)/s);r.chars[l]={xOffset:parseInt(f.getAttribute("xoffset"),10)/s,yOffset:parseInt(f.getAttribute("yoffset"),10)/s,xAdvance:parseInt(f.getAttribute("xadvance"),10)/s,kerning:{},texture:new Tiny.Texture(n.baseTexture,c)}}for(var h=t.getElementsByTagName("kerning"),p=0;p<h.length;p++){var g=h[p],y=parseInt(g.getAttribute("first"),10)/s,d=parseInt(g.getAttribute("second"),10)/s,m=parseInt(g.getAttribute("amount"),10)/s;r.chars[d]&&(r.chars[d].kerning[y]=m)}return e.fonts[r.font]=r,r}}]),e}(Tiny.Container);a.fonts={},e.default=a}])});